# Kickstart file automatically generated by anaconda.

#version=DEVEL
install
text
url --url=http://192.168.1.52/centos5/
#url --url=http://113.192.17.3:8080/centos5/x86_64/

#repo --name="CentOS"  --baseurl=http://113.192.17.3:8080/centos5/x86_64/ 
repo --name="CentOS"  --baseurl=http://192.168.1.52/centos5/x86_64/ 
repo --name="updates"  --baseurl=http://mirror.optus.net/centos/5/updates/x86_64/
 
repo --name="Extras"  --baseurl=http://mirror.optus.net/centos/5/extras/x86_64/
repo --name="epel"  --baseurl=https://dl.fedoraproject.org/pub/epel/5/x86_64/
repo --name="mycloud"  --baseurl=http://192.168.1.52/centos5-cloud/


lang en_US.UTF-8
keyboard us
network --onboot yes --device eth0 --mtu=1500 --bootproto dhcp --nameserver 192.168.1.1 --hostname changeme

rootpw  --iscrypted $1$nroTSYJT$w1.TSIJEPry/WsIw1YCoZ0

firewall --port=22:tcp --port=80:tcp
authconfig --enableshadow --enablemd5
selinux --enforcing
timezone --utc Australia/Sydney
bootloader --location=mbr --driveorder=vda --append="crashkernel=auto console=tty0 console=ttyS0,115200n8"
# The following is the partition information you requested
# Note that any partitions you deleted are not expressed
# here so unless you clear all partitions first, this is
# not guaranteed to work
zerombr yes 
#clearpart --all --drives=vda --initlabel
clearpart --all --initlabel

part / --fstype=ext3 --size=1 --grow

# the Setup Agent is not started the first time the system boots
firstboot --disable


# reboot when installation completes
#poweroff
shutdown

%packages --nobase
@Core
kexec-tools
keyutils
ntp
kernel
nfs-utils
rsync
yum-utils
vim-enhanced
openssh-clients
curl
wget
epel-release
sudo
man
man-pages
audit
bash-completion
ntp
tmux
rsync
rsyslog
syslinux
iptables
parted
nfs-utils
attr
acpid
postfix
cloud-init
cloud-utils
cloud-utils-growpart

-sendmail
-*firmware
-iscsi-initiator-utils

#%end

%post --interpreter /bin/bash 
exec < /dev/tty3 > /dev/tty3
chvt 3
echo
echo "################################"
echo "# Running Post Configuration   #"
echo "################################"
#(
wget -q -O  /sbin/ec2-metadata http://s3.amazonaws.com/ec2metadata/ec2-metadata
chmod a+rx  /sbin/ec2-metadata

mkdir -p /root/.ssh
chmod 700 /root/.ssh
rm -f /root/anaconda-ks.cfg
rm -f /root/install.log*
passwd -d root
passwd -l root


touch /root/firstrun

sed -i "/HWADDR/d" /etc/sysconfig/network-scripts/ifcfg-eth0
rm -rf lost+found
rm -rf /tmp/*

cat <<EOF >> /etc/yum.conf

multilib_policy=best
exclude=*.i386 *.i686

EOF


echo -e "##############################"
echo "Adding admin user"
echo -e "##############################\n"

sed -i 's/# %wheel        ALL=(ALL)       NOPASSWD: ALL/%wheel        ALL=(ALL)       NOPASSWD: ALL/' /etc/sudoers
echo 'Defaults env_keep += "PATH PYTHONPATH"' >> /etc/sudoers

/sbin/chkconfig --level 345 firstboot off 2>/dev/null
echo "RUN_FIRSTBOOT=NO" > /etc/sysconfig/firstboot

echo -e "##############################"
echo "Confing ntp service"
echo -e "##############################\n"

cat <<EOF > /etc/ntp.conf
server 0.amazon.pool.ntp.org iburst
server 1.amazon.pool.ntp.org iburst
server 2.amazon.pool.ntp.org iburst
server 3.amazon.pool.ntp.org iburst

EOF

echo '30 * * * * root /usr/sbin/ntpd -q -u ntp:ntp' > /etc/cron.d/ntpd

# turn on ntpd
/sbin/chkconfig ntpd on 2>/dev/null

mkdir -p /etc/cloud/ 
cat > "/etc/cloud/cloud.cfg" << END
users:
 - default

disable_root: 1
ssh_pwauth:   0

locale_configfile: /etc/sysconfig/i18n
mount_default_fields: [~, ~, 'auto', 'defaults,nofail', '0', '2']
resize_rootfs_tmp: /dev
ssh_deletekeys:   0
ssh_genkeytypes:  ~
syslog_fix_perms: ~

cloud_init_modules:
 - migrator
 - bootcmd
 - write-files
 - growpart
 - resizefs
 - set_hostname
 - update_hostname
 - update_etc_hosts
 - rsyslog
 - users-groups
 - ssh

cloud_config_modules:
 - mounts
 - locale
 - set-passwords
 - yum-add-repo
 - package-update-upgrade-install
 - timezone
 - puppet
 - chef
 - salt-minion
 - mcollective
 - disable-ec2-metadata
 - runcmd

cloud_final_modules:
 - rightscale_userdata
 - scripts-per-once
 - scripts-per-boot
 - scripts-per-instance
 - scripts-user
 - ssh-authkey-fingerprints
 - keys-to-console
 - phone-home
 - final-message

system_info:
  default_user:
    name: centos
    lock_passwd: true
    gecos: Cloud User
    groups: [wheel, adm]
    sudo: ["ALL=(ALL) NOPASSWD:ALL"]
    shell: /bin/bash
  distro: rhel
  paths:
    cloud_dir: /var/lib/cloud
    templates_dir: /etc/cloud/templates
  ssh_svcname: sshd

# vim:syntax=yaml
END

mkdir -p /etc/cloud/cloud.cfg.d
cat > "/etc/cloud/cloud.cfg.d/10-growpart.cfg" << END
growpart:
  mode: auto
  devices: ['/']
  ignore_growroot_disabled: false

END

/sbin/chkconfig --level 345 network on 

echo -e "##############################"
echo "Disabling unnecessary services"
echo -e "##############################\n"

for s in atd autofs isdn messagebus \
                 smartd yum-updated portmap nfslock \
          iscsi iscsid cpuspeed bluetooth kudzu ip6tables \
         netfs xfs; do
        echo "Disabling $s at all levels"
        /sbin/chkconfig --level 0123456 $s off
done


#) 2>&1 | /usr/bin/tee /var/log/post_install.log
chvt 1
%end

%post --nochroot
%end
